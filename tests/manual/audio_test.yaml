name: audio_atomic_pipeline
description: "Pipeline kiểm tra Audio Server theo hướng nguyên tử hóa (Atomic Logic)"

# Cấu hình server MCP
servers:
  audio: src/xfmr_zem/servers/audio/server.py

# Định nghĩa luồng xử lý chi tiết
pipeline:
  # 1. Tiền xử lý
  - name: step1_preprocess
    audio.preprocess:
      input:
        data:
          - audio_path: "tests/data/sample_audio.wav"
        audio_column: "audio_path"
        output_column: "clean_audio"
    cache: false

  # 2. Nhận diện người nói
  - name: step2_diarize
    audio.diarize:
      input:
        data: "$step1_preprocess"
        audio_column: "clean_audio"
        rttm_column: "rttm_file"
        output_dir: "./output/rttm"
    cache: false

  # 3. Cắt nhỏ Audio (Slicing) - Bước mới tách ra
  - name: step3_slice
    audio.slice:
      input:
        data: "$step2_diarize"
        audio_column: "clean_audio"
        rttm_column: "rttm_file"
        output_dir: "./output/chunks"
    cache: false

  # 4. Dịch từng đoạn (Transcription) 
  # Lúc này input là danh sách các chunk từ bước 3
  - name: step4_transcribe
    audio.transcribe:
      input:
        data: "$step3_slice"
        audio_column: "chunk_path"
        text_column: "segment_text"
        model: "zzasdf/viet_iter3_pseudo_label"
    cache: false

  # 5. Hợp nhất kết quả (Merging) - Bước mới tách ra
  - name: step5_final_merge
    audio.merge:
      input:
        data: "$step4_transcribe"
        text_column: "segment_text"
        group_by: "original_audio"
    cache: false

# Tham số cấu hình
parameters:
  audio:
    asr:
      device: "cuda"
    diarization:
      device: "cuda"
